# Django 회원가입 만들기

## 0. app 생성 및 등록

### 0-0. bash

```bash
# auth와 관련한 경로나 키워드들을 Django 내부적으로 accounts라는 이름으로 사용하고 있기 때문에 되도록 accounts로 지정하는 것을 권장
$ python manage.py startapp accounts
```

### 0-1. settings.py

```python
INSTALLED_APPS = [
    "accounts",
    ...
]
```

<br/>

## 1. app urls 분리

### 1-0. pjt/urls.py

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path("admin/", admin.site.urls),
    path("accounts/", include("accounts.urls")),
]
```

### 1-1. accounts/urls.py

```python
from django.urls import path
from . import views

app_name = "accounts"

urlpatterns = [
    
]
```

<br/>

## 2. Custom User Model

### 2-0. settings.py

```python
# 프로젝트에서 User를 나타낼 때 사용하는 모델
# 프로젝트가 진행되는 동안 (모델을 만들고 마이그레이션한 후) 변경할 수 없음
# 첫 번째 마이그레이션 전에 확정지어야 함
# 다음과 같은 기본값을 가짐
AUTH_USER_MODEL = "auth.User"
```

### 2-1. accounts/models.py

```python
from django.db import models
from django.contrib.auth.models import AbstractUser

class User(AbstractUser):
    pass
```

### 2-2. settings.py

```python
# Custom User Model로 지정
AUTH_USER_MODEL = "accounts.User"
```

### 2-3. accounts/admin.py

```python
# 기본 User 모델이 아니기 때문에 등록하지 않으면 admin site에 출력되지 않음
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

admin.site.register(User, UserAdmin)
```

### [참고] User 모델 상속 관계

```python
models.Model -> class AbstractBaseUser -> class AbstractUser -> class User
```

### 2-4. DB 생성

```bash
$ python manage.py makemigrations

$ python manage.py migrate
```

<br/>

## 3. admin 관리

### 3-0. 관리자 아이디 생성

```bash
$ python manage.py createsuperuser
Username: admin
Email address: 
Password:
Password (again):

# 127.0.0.1:8000/admin/으로 접속 후 로그인
```

<br/>

## 4. User 객체 활용

- User 생성

  ```python
  user = User.objects.create_user("john", "john@google.com", "1q2w3e4r!")
  ```

- User 비밀번호 변경

  ```python
  user = User.objects.get(pk=2)
  User.set_password("new password")
  User.save()
  ```

- User 인증 (비밀번호 확인)

  ```python
  from django.contrib.auth import authenticate
  
  user = authenticate(username="john", password="secret")
  ```

<br/>

## 5. 회원가입 만들기

### 5-0. accounts/urls.py

```python
urlpatterns = [
    path("signup/", views.signup, name="signup"),
]
```

### 5-1. accounts/views.py

```python
from django.contrib.auth.forms import UserCreationForm


def signup(request):
    if request.method == 'POST':
	    form = UserCreationForm()
        
        if form.is_valid()
        	form.save()
            
            return redirect("accounts/index")
    else:
        form = UserCreationForm()
            
    context = {
        "form": form,
    }

    return render(request, "accounts/signup.html", context)
```

### 5-2. accounts/signup.html

```html
<h1>SignUp</h1>

<form action="{% url 'accounts:signup' %}" method="POST">
  {% csrf_token %}
  {{ form.as_p }}
</form>
```

### 5-3. UserCreationForm() 커스텀 하기

#### 5-3-0. accounts/forms.py

```python
from django.contrib.auth import get_user_model
from django.contrib.auth.model import UserCreationForm

# 기존 UserCreationForm을 상속받아 User 모델 재정의
class CustomUserCreationForm(UserCreationForm):
    class Meta:
        
        # 현재 프로젝트에서 활성화된 사용자 모델(active user model)을 반환
        # Django에서는 User 클래스는 커스텀을 통해 변경 가능, 직접 참조 대신 get_user_model() 사용 권장
        model = get_user_model()
        fields = [
            "username",
        ]
```

#### 5-3-1. accounts/views.py

```python
from django.shortcuts import render, redirect
from django.contrib.auth.forms import UserCreationForm
from .forms import CustomUserCreationForm


def signup(request):
    if request.method == "POST":
        # CustomUserCreationForm()으로 대체하기
        form = UserCreationForm()

        if form.is_valid():
            form.save()

            return redirect("accounts/index")

    else:
        # CustomUserCreationForm()으로 대체하기
        form = UserCreationForm()

    context = {
        "form": form,
    }

    return render(request, "accounts/signup.html", context)

```

